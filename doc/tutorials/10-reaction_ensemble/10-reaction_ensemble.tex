% Copyright (C) 2010,2011,2012,2013,2014,2015,2016 The ESPResSo project
% Copyright (C) 2002,2003,2004,2005,2006,2007,2008,2009,2010 
%   Max-Planck-Institute for Polymer Research, Theory Group
%  
% This file is part of ESPResSo.
%   
% ESPResSo is free software: you can redistribute it and/or modify it
% under the terms of the GNU General Public License as published by the
% Free Software Foundation, either version 3 of the License, or (at your
% option) any later version.
%  
% ESPResSo is distributed in the hope that it will be useful, but
% WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
% General Public License for more details.
%  
% You should have received a copy of the GNU General Public License
% along with this program.  If not, see <http://www.gnu.org/licenses/>.
%


\documentclass[
a4paper,                        % paper size
11pt,                           % font size
twoside,                        % two sided
footsepline,                    % add a line to separate the footer
headsepline,                    % add a line to separate the header
headexclude,                    % header does not belong to the text
footexclude,                    % footer does not belong to the text
pagesize,                       % set the pagesize in a DVI document
]{scrartcl}

\usepackage[version=4]{mhchem}
\usepackage{hyperref}
\usepackage{graphicx}

\include{common}

\begin{document}
\title{Tutorial 3: Reaction Ensemble and Constant pH ensemble}
\author{Andrea Tagliabue, Jonas Landsgesell}

\maketitle
\tableofcontents

\section{Introduction}

This tutorial introduces the basic features for simulating tritatable systems via two different methods, the Constant pH method and the Reaction Ensamble method, pointing out differences and similarities between these two approaches and explaining the reasons to prefer the latter in some particular cases.
The first part of this tutorial will be an homogeneous aqueous solution of a titratable acidic species HA that could dissociate as follows:
The second part of this tutorial will be instead a polyelectrolytic chain formed by a series of titratable monomers bonded together.

\noindent Both constant pH and Reaction Ensemble methods are implemented via a Monte Carlo algorithm with the classical Metropolis-Hastings acceptation rule. Here we compare both methods based on the paper published by Landsgesell et. al\cite{landsgesell2017simulation}.

\section{Theoretical Background}

In this tutorial we deal with chemical reactions of the following kind.
\begin{equation}\label{disso}
\ce{HA <--> A- + H+}
\end{equation}
If $N_0 = N_{HA} + N_{A-}$ is the number of titratable groups in solution, a degree of dissociation $\alpha$ can be defined:
\begin{equation}\label{alpha}
\alpha = \frac{N_{A^-}}{N_0}.
\end{equation}
Another observable is the degree of association which is given by:
\begin{equation*}
\overline{n}=\frac{N_{HA}}{N_0}=1-\alpha.
\end{equation*}
The equilibrium concentration of each species is defined by the equilibrium reaction constant
\begin{equation}
K =\exp(\beta \sum_i (\mu_i-\mu_i^0) \nu_i)= \frac{a(\text{A}^-)a(\text{H}^+)}{a(\text{HA})},
\end{equation}
where $a(i)$ denotes the relative activity $a(i)=\exp(\frac{\mu_i-\mu_i^0}{k_BT})$ of the individual species, where $\mu$ is the chemical potential of species $i$ and $\mu_i^0$ the chemical potential of species $i$ under some standard condition. In the case of non-interacting particles (ideal gas) the activities are equal to $c_i/c_i^0$. In chemical equilibrium which is defined by $\Delta G=\sum_i \nu_i \mu_i=0$ we obtain that $K=\exp(\beta \Delta (G-G^0))=\exp(-\beta \sum_i \nu_i \mu_i^0)$.
Therefore we have (in the case of no interactions):
\begin{equation}
\exp(-\beta ( \mu_H^0+\mu_A^0-\mu_{HA}^0))=\prod_i \frac{(c_{H}/c^0_H)(c_{A}/c^0_A)}{(c_{HA}/c^0_{HA})}
\end{equation}
or equivalently:
\begin{equation}
K_c:=\prod_i \frac{c_{H}c_{A}}{c_{HA}}=\text{const}:=\Gamma,
\end{equation}
where $K_c$ carries the dimension 1/volume.


\subsection{Constant pH method}

In the constant pH method, the acceptance probability for a reaction is:

\begin{equation} 
P_{\text{acc}} = \text{min}\left\lbrace  1, e^{\Delta E_\text{pot}/(k_BT) \pm \ln{10} (\text{pH - pK}_\text{a})}\right\rbrace  \text{,}
\end{equation}
and the proposal probability of a reaction is $P_\text{prop}=\frac{N_{HA}}{N0}$ for a dissociation and $P_\text{prop}=\frac{N_{A}}{N0}$ for an association reaction\cite{landsgesell2017simulation}.
 
Here $\Delta E_\text{pot}$ is the potential energy change due to the reaction and $\text{pH - pK}_\text{a}$ is an input parameter. The chemical prefactor $\pm 1$ defines the direction of the reaction (+1 dissociation, -1 association).
When a dissociation move is accepted, the titratable molecule HA is charged and a counterion is randomly placed into the simulation box. When, vice versa, an association move is accepted, the titratable chosen A- is neutralized ad a random counterion is removed from the cell.


\subsection{Reaction Ensemble method}
A chemical reaction involving ${n}$ species of type ${s_i}$ and with stoichiometric coefficients $\nu_i$ can be written as 
\begin{equation}
\sum_{i = 1}^n \nu_{i} s_i = 0\text{.}
\end{equation}
For such a general reaction, the acceptance probability in the Reaction Ensemble method is defined as
\begin{equation}\label{RE}
P_{\text{acc}} = \text{min} \left\lbrace 1, \Gamma^\xi V^{\bar{\nu}\xi} \prod_{i = 1}^{n} \left[ \frac{N_{i}^0!}{(N_{i}^{0} + \xi \nu_i)}  \right] e^{-\beta \Delta E_\text{pot}}  \right\rbrace\text{.}
\end{equation}
Here $\Gamma$ is the ideal reacting gas quantity introduced above, $V$ the volume, $\bar{\nu}$ the total change in the number of particles, $N_0^i$ the number of particles prior to the reaction and $\xi$ is the extent of the reaction, which could assume value +1 (forward reaction) or -1 (backward reaction). Each reaction is proposed with uniform probability. 

\noindent For reaction \ref{disso} eq. \ref{RE} can be simplified becoming 
\begin{equation}
P_{\text{acc}} = \text{min} \left\lbrace 1, (  \Gamma \frac{N_{HA}}{N_A - N_{H+}/V)} e^{-\beta \Delta E_\text{pot}}  \right\rbrace\text{.}
\end{equation}

As you could see, the main difference in the two methods consists in the fact that in Reaction Ensemble the pH is determined via the actual proton concentration in the simulation box, while in Constant pH method it represents an input parameter which remains constant during all the simulation.


\section{First part: homogeneous aqueous solution of acidic species}

\subsection{System Setup}

We start defining some important input parameters and setting the particles randomly inside the box:
\begin{verbatim}
import espressomd
from espressomd import reaction_ensemble
system = espressomd.System(box_l=[box_l]*3)
system.set_random_state_PRNG()
\np.random.seed(seed=system.seed)

N = 50             #number of titratable particles
K_diss = 8.3**(-4) #dissociation costant 
box_l = 50         #side length of our cubic simulation box 

for i in range(N0):
    system.part.add(id=i, pos=np.random.random(3) * system.box_l, type=1)
for i in range(N0, 2 * N0):
    system.part.add(id=i, pos=np.random.random(3) * system.box_l, type=2)
\end{verbatim}

Obviously, for each negative charged \ce{A-} particle (type = 1) we had to put in the simulation box the respective counterion \ce{H+} (type = 2) in order to maintain the electroneutrality of the system.
Notice that the implementation in Espresso requires that the dimension of the equilibrium constant is consistent with its internal unit of volume; rules for a correct conversion of $K_a$ (experimental) to $\Gamma$ (in internal units) are explained in the user guide: \url{http://espressomd.org/html/doc/advanced_methods.html}. The next step is to define the reaction:

\begin{verbatim}
RE=None
mode=="reaction_ensemble"
if(mode=="reaction_ensemble"):
    RE = reaction_ensemble.ReactionEnsemble(temperature=1, exclusion_radius=1)
elif(mode=="constant_pH_ensemble"):
    RE = reaction_ensemble.ConstantpHEnsemble(temperature=1, exclusion_radius=1)
    RE.constant_pH=7
    RE.add_reaction(gamma=K_diss, reactant_types=[0], reactant_coefficients=
     [1], product_types=[1, 2], product_coefficients=[1, 1], default_charges=
     {0: 0, 1: -1, 2: +1})
print(RE.get_status())
system.setup_type_map([0, 1, 2])
\end{verbatim}
You can switch from one method to the other simply by changing the "mode" parameter. Now the system is ready for being simulated:

\begin{verbatim}
Nreac = 10**4 #number of association/dissociation attempt to be performed
for i in range(Nreac):
    RE.reaction()
\end{verbatim}

Notice that, as this level, we're not taking into account electrostatic interactions between charged species. If  you compare the input equilibrium constant $\Gamma$ with the one can calculat at the end of a simulation run: $K_{sim} = \frac{<[\ce{A-}]><[\ce{H+}]>}{<[\ce{HA}]>}$ one observes that both are equal in the case of no interactions present. This is not true when e.g. electrostatic interaction are enabled due to the fact the latter introduces an excess chemical potential.


\subsection{Dissociation degree versus concentration}

Performing several simulation with constant $N_0$ but varying the dimension of the simulation box it is possible to obtain the dissociation degree $\alpha$ (eq. \ref{alpha}) as a function of the concentration of tritatable units. Results are shown in figure \ref{alpha_vs_C}.

\begin{figure}[tb]
	\centering
 	\includegraphics[scale=0.5]{figures/alpha_vs_C.png}
 	\caption{Dissociation degree $\alpha$ as function of the concentration of tritatable groups. Green: Constant pH method; violet: Reaction Ensemble method; black: ideal behavior.}
 	\label{alpha_vs_C}
\end{figure}

As you can see, only the curve obtained with the Reaction Ensemble method fits the ideal behavior described by the diluition law
\begin{equation}
K_{a} = \frac{\alpha^2}{1 - \alpha}c_0\text{,}
\end{equation}
and this is due to the fact that the acceptance  rule in Constant pH method does not depend on the volume of the system. As $\alpha$ differs, also the number of counterion in the cell is different, and this could have a strong impact on screening effects when electrostatic interactions are taken into account. Moreover, in Constant pH method the real chemical nature of counterions is unknown. In fact, when a HA molecule dissociates at high pH value, the generated \ce{H+} would react instantaneously with an \ce{OH-} ions, so the positively charged ions that remains in solution must represent a different species (e.g. a \ce{Na+} cation).



\section{Second part: linear weak polyelectrolyes}
Weak polyelectrolytes are a family of responsive materials whose application spans the range from flocculation-induced water purification to tissue targeted drug delivery of expensive or cytotoxic medicines. Their properties, however, depend on their specific chemical environment, with details such as pH, salt concentration and valency, and their topology markedly modifying the chemical behavior of their ionizing groups.
Here we're going to study the titration curves of a linear weak polyelectrolytes composed by 50 titratable units with both Reaction Ensemble and Constant pH methods. In this case, we'll enable electrostatic interactions between charged species in order to correctly describe their properties.
\begin{verbatim}
# setting up electrostatics
from espressomd import electrostatics
p3m = electrostatics.P3M(prefactor = l_bjerrum*temperature, accuracy=1e-3) 
system.actors.add(p3m)
\end{verbatim}
First af all, we had to define a few important  parameters:
\begin{verbatim}
# system parameters defined in terms of internal unit sigma = 3.55 Angstrom 
box_l = 56.134 
l_bjerrum = 2.0 
temperature = 1.
system = espressomd.System(box_l=[box_l]*3)


# setup partilcles
# when you have to handle with many differet type of species in your system,
# make sure to define variables and dictonaries that can be helpful to reduce
# mistakes when you write your scripts.
N_P = 1       #number of chains
MPC = 50      #monomers per chain
N0 = N_P*MPC  #total number of monomers
nNaOH = 0     #number of initial Na+OH-
nHCl = 0      #number of initial H+Cl- (additional H+'s)

type_HA = 0   # type 0 = HA
type_A  = 1   # type 1 = A-
type_H  = 2   # type 2 = H+
type_OH = 3   # type 3 = OH-
type_Na = 4   # type 4 = Na+
type_Cl = 5   # type 5 = Cl-

charges={}
charges[type_HA] =  0    
charges[type_A]  = -1     
charges[type_H]  =  1
charges[type_OH] = -1
charges[type_Na] =  1
charges[type_Cl] = -1 
\end{verbatim}
Here, we've defined polymers titratable units (\ce{HA <--> A-}), counterions \ce{H+}, and \ce{Na+OH-} and \ce{H+Cl-} ionic species, which can be inserted inside the simulation box in order to titrate the polymer. Let's set up the polymer, its counterions and bonding interactions between monomers. 

\begin{verbatim}
# bonding interaction parameter
bond_l = 1.2       #bond length
kbond = 100        #force constant for harmonic bond
harmonic_bond = interactions.HarmonicBond(k=kbond, r_0=bond_l)
system.bonded_inter.add(harmonic_bond)

# setting up the polymer
polymer.create_polymer(N_P = N_P, bond_length = bond_l, MPC=MPC, start_id=0, 
bond=harmonic_bond, type_poly_neutral=type_HA, type_poly_charged=type_A, mode=0,
val_poly=charges[type_A])
# setting up counterions
for i in range(N0):
system.part.add(pos=np.random.random(3) * system.box_l, type=type_H, q=charges[type_H])
\end{verbatim}

To titrate a polyelectrolytic chain, which is composed by $N_0$ titratable units with a certain $`\text{p}K_a$, in the Reaction Ensemble we need to modulate the pH of the environment. To do this, we need to add additional \ce{H+} (increasing the pH) or $OH-$ ions (to decrease it). We need also to introduce the respective counterions to preserve the electroneutrality of the system. We need also to take into account also the autoprotolysis of water.

\begin{verbatim}
K_diss = 0.002694            #eq constant HA <--> A- + H+
K_w = 10.**(-14)*0.02694**2  #eq constant for autoprotolysis

#HA <--> A- + H+
RE.add_reaction(gamma=K_diss, reactant_types=[type_HA],
    reactant_coefficients=[1],    product_types=[type_A, type_H], 
    product_coefficients=[1,1], default_charges={type_HA: charges[type_HA], 
    type_A: charges[type_A], type_H: charges[type_H]})

#H2O autoprotolysis 
RE.add_reaction(gamma=(1/K_w), reactant_types=[type_H, type_OH], 
reactant_coefficients=[1,1], product_types=[],    product_coefficients=[],    
default_charges={type_H: charges[type_H], type_OH: charges[type_OH]})
\end{verbatim}

Due to the fact that, at a certain pH, the ionization degree of a weak polyelectrolytes depends on its spatial conformation, in order to obtain  correctly averaged values we have also to couple the reaction algorithm with MD simulations. 

\begin{verbatim}
# Integration parameters
system.time_step = 0.02
system.cell_system.skin = 1. #only for tutorial purposes 
system.cell_system.max_num_cells = 2744
system.thermostat.set_langevin(kT=temperature, gamma=1.0)
\end{verbatim}
Finally, we are ready to run the simulation!
\begin{verbatim}
for i in range(12000):
RE.reaction()
system.integrator.run(300) # this is for tutorial only, too less integrations
if(i % 50 == 0):
print(i,") HA", system.number_of_particles(type=type_HA), "A-",
 system.number_of_particles(type=type_A), "H+",
  system.number_of_particles(type=type_H), 'OH-',
   system.number_of_particles(type=type_OH), 'Cl-',
    system.number_of_particles(type=type_Cl), 'NA+',
     system.number_of_particles(type=type_Na))
\end{verbatim}

\subsection{Titration curves}

\begin{figure}[tb]
	\centering
	\includegraphics[scale=0.5]{figures/titration.png}
	\caption{Titration curves for a weak polyelectrolytic chain composed by $N_0=50$ titratable monomers. Green: Constant pH method; violet: Reaction Ensemble mthod:; black: ideal behavior.}
	\label{titration}
\end{figure}

For a solution of weak acidic molecules with a certain $\text{p}K_a=-log_{10}{\Gamma/c^0}$, the trend of $\alpha$ as function of pH is described by the Henderson-Hasselbalch equation (black curve in fig. \ref{titration}):
\begin{equation}
\text{pH} = -\log_{10}(c(H+)/c^0)
\end{equation}
However, when titratable units are bonded together in a polyelectrolytic chain their effective $\text{p}K_{a}^{(eff)}$ differs from the ideal one $\text{p}K_a$; this cam be described by the fact that when the charge carried by a dissociated monomer tends to partially inhibit the dissociation of its neighbors (at electrostatic interaction strengths present in water), and this results into a lower total degree of dissociation with respect to the non-bonded acidic units case. Anyway, this effect can be partially compensated by the presence of counterions, which are able to  screen repulsive interactions between dissociated monomers. As you can observe in figure \ref{titration}, Constant pH and Reaction Ensemble method results are very similar at high pH values, but they show very pronounced differences at low pH values. More in details, $pK_{a}^{(eff)}$ tends to the ideal one when the concentration of \ce{H+} is high. This depends on the fact that with Reaction Ensemble method we have to inject a strong acid (\ce{H+}\ce{Cl-}) in order to titrate the polymer, and this results in a more salty solution with a strong screening power. This behavior would be reversed in case of a weak poly-base, with superimposable curves at low pH values and the Reaction Ensemble one approaching the ideal one when the amount of \ce{OH-} ions becomes relevant.
 

\section{Distribution of charges onto the chain}

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.5]{figures/qdistrib.png}
	\caption{Mean charges of monomers as function of their position along the chain (calculated via Reaction Ensemble method) at $\text{pH - p}K_a = 2$ Notice that the curve is noisy because of the short duration of the simulation. Make sure to perform longer simulations to achieve a better convergence.}
	\label{qdistrib}
\end{figure}
Figure \ref{qdistrib} shows the mean charge assumed by each monomer during the simulation in function of its position along the chain. As you can observe, monomers lying at the extremities tend to be more charged than those that lie in the innermost regions. This could be easily explained thinking that the ends of the chain can better arrange in space in order to minimize repulsive interactions between charges. This results do not depend on the method, i.e. the shape of the curve at a certain dissociation degree would be te same also with the Constant pH; however, as previously discussed, at a certain value $\text{pH - p}K_a$, the total dissociation degree depends on the method, so the Constant pH curve would results shifted to lower mean charge values for a weak poly-acid at high pH values.

\bibliographystyle{unsrt}
\bibliography{references}

\end{document}
