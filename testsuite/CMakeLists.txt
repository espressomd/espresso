if(NOT DEFINED TEST_NP)
  include(ProcessorCount)
  ProcessorCount(NP)
  math(EXPR TEST_NP "${NP}/2 + 1")
endif()

function(PYTHON_TEST)
  cmake_parse_arguments(TEST "" "FILE;MAX_NUM_PROC" "" ${ARGN} )
  get_filename_component(TEST_NAME ${TEST_FILE} NAME_WE)

  if(${TEST_MAX_NUM_PROC} LESS ${TEST_NP})
    set(TEST_NUM_PROC ${TEST_MAX_NUM_PROC})
  else()
    set(TEST_NUM_PROC ${TEST_NP})
  endif()

  if(EXISTS ${MPIEXEC})
    add_test(${TEST_NAME} ${MPIEXEC} ${MPIEXEC_NUMPROC_FLAG} ${TEST_NUM_PROC} ${CMAKE_BINARY_DIR}/pypresso ${TEST_FILE})
  else()
    add_test(${TEST_NAME} ${CMAKE_BINARY_DIR}/pypresso ${TEST_FILE})
  endif()

  set(python_tests ${python_tests} ${TEST_FILE} PARENT_SCOPE)
endfunction(PYTHON_TEST)

python_test(FILE cellsystem.py MAX_NUM_PROC 4)
python_test(FILE constraint_homogeneous_magnetic_field.py MAX_NUM_PROC 4)
python_test(FILE constraint_shape_based.py MAX_NUM_PROC 4)
python_test(FILE coulomb_cloud_wall.py MAX_NUM_PROC 4)
python_test(FILE coulomb_tuning.py MAX_NUM_PROC 4)
python_test(FILE correlation.py MAX_NUM_PROC 4)
python_test(FILE dawaanr-and-dds-gpu.py MAX_NUM_PROC 4)
python_test(FILE electrostaticInteractions.py MAX_NUM_PROC 4)
python_test(FILE engine_langevin.py MAX_NUM_PROC 4)
python_test(FILE engine_lb.py MAX_NUM_PROC 1)
python_test(FILE engine_lbgpu.py MAX_NUM_PROC 1)
python_test(FILE ewald_gpu.py MAX_NUM_PROC 4)
python_test(FILE icc.py MAX_NUM_PROC 4)
python_test(FILE magnetostaticInteractions.py MAX_NUM_PROC 1)
python_test(FILE mass-and-rinertia_per_particle.py MAX_NUM_PROC 1)
python_test(FILE interactions_bond_angle.py MAX_NUM_PROC 4)
python_test(FILE interactions_bonded_interface.py MAX_NUM_PROC 4)
python_test(FILE interactions_bonded.py MAX_NUM_PROC 4)
python_test(FILE interactions_non-bonded_interface.py MAX_NUM_PROC 4)
python_test(FILE interactions_non-bonded.py MAX_NUM_PROC 4)
python_test(FILE observables.py MAX_NUM_PROC 4)
python_test(FILE p3m_gpu.py MAX_NUM_PROC 4)
python_test(FILE particle.py MAX_NUM_PROC 4)
python_test(FILE stress.py MAX_NUM_PROC 4)
python_test(FILE scafacos_dipoles_1d_2d.py MAX_NUM_PROC 4)
python_test(FILE tabulated.py MAX_NUM_PROC 4)
python_test(FILE particle_slice.py MAX_NUM_PROC 4)
python_test(FILE rigid_bond.py MAX_NUM_PROC 4)
python_test(FILE rotation_per_particle.py MAX_NUM_PROC 4)
python_test(FILE rotational_inertia.py MAX_NUM_PROC 4)
python_test(FILE script_interface_object_params.py MAX_NUM_PROC 4)
python_test(FILE lbgpu_remove_total_momentum.py MAX_NUM_PROC 4)
python_test(FILE tabulated.py MAX_NUM_PROC 4)
python_test(FILE reaction_ensemble.py MAX_NUM_PROC 4)
python_test(FILE constant_pH.py MAX_NUM_PROC 4)
python_test(FILE writevtf.py MAX_NUM_PROC 4)
python_test(FILE lb_stokes_sphere_gpu.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_x.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_y.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_z.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_x_nonlinear.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_y_nonlinear.py MAX_NUM_PROC 1)
python_test(FILE ek_eof_one_species_z_nonlinear.py MAX_NUM_PROC 1)
python_test(FILE exclusions.py MAX_NUM_PROC 4)
python_test(FILE langevin_thermostat.py MAX_NUM_PROC 2)
python_test(FILE nsquare.py MAX_NUM_PROC 4)
python_test(FILE virtual_sites_relative.py MAX_NUM_PROC 2)
python_test(FILE domain_decomposition.py MAX_NUM_PROC 4)
python_test(FILE layered.py MAX_NUM_PROC 4)
python_test(FILE minimize_energy.py MAX_NUM_PROC 4)
python_test(FILE mmm1d.py MAX_NUM_PROC 4)
python_test(FILE virtual_sites_relative.py MAX_NUM_PROC 2)
python_test(FILE variant_conversion.py MAX_NUM_PROC 1)
python_test(FILE dipolar_mdlc_p3m_scafacos_p2nfft.py MAX_NUM_PROC 1)
python_test(FILE lb.py MAX_NUM_PROC 4)
python_test(FILE lb_gpu.py MAX_NUM_PROC 2)
python_test(FILE lb_stokes_sphere_gpu.py MAX_NUM_PROC 1)
python_test(FILE analyze_energy.py MAX_NUM_PROC 4)
python_test(FILE rdf.py MAX_NUM_PROC 1)
python_test(FILE coulomb_cloud_wall_duplicated.py MAX_NUM_PROC 4)

if(PY_H5PY)
  python_test(FILE h5md.py MAX_NUM_PROC 2)
endif(PY_H5PY)

add_custom_target(python_tests
  COMMAND ${CMAKE_COMMAND} -E copy_directory ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_BINARY_DIR})

add_custom_target(check_python COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure)
add_dependencies(check_python pypresso python_tests)
add_dependencies(check check_python)
